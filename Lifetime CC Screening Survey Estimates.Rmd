---
title: "CC Testing Ever"
subtitle: "Note that all of the Southern African country surveys only asked about pap smears, and all the other sub-saharan country surveys outside of WHS asked about CC testing in general"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      warning = F)
```

```{r import}
library(haven)
library(dplyr)
library(survey)
library(ggplot2)
library(readxl)
source("df_functions.R") #functions created for dataframes
load("Cleaned Indv Surveys") #from Combine Clean Surveys.Rmd
load("Cleaned Pooled Surveys") #from Combine Clean Surveys.Rmd

surveys <- read_excel("surveys.xlsx", sheet = 1)
all_q <- read_excel("surveys.xlsx", sheet = 2)
```

# Proportion cc tested ever
```{r age settings}
agegr <- data.frame(c(15, 18, 15, 25, 30, 50, seq(15, 65, 5), 0), c(49, 49, 29, 49, 49, 1000, seq(19, 64, 5), 1000, 1000))
df <- data.frame(agegr = c("15-49", "18-49", "15-29", "25-49", "30-49", "50-65+", 
                                "15-19", "20-24", "25-29", "30-34", "35-39", 
                                "40-44", "45-49", "50-54", "55-59", "60-64", "65-1000", "All"))
options(survey.lonely.psu="adjust")
```
```{r prop tested ever function}
#function for general cc testing
evercctested <- function(df, age1, age2){
  sub_df <- filter(df, age >= age1 & age <= age2 & !is.na(ever_cc_tested))
  
  if(nrow(sub_df) <= 1){ #done for age groups that have 1 or less people
    return(data.frame("Mean" = NA, "Lower" = NA, "Upper" = NA))
    
  }else{
    if(length(sub_df$strata) != 0){ #need to double check that I can do this
      design <- svydesign(data = sub_df, weights = ~weight, id = ~psu, strata = ~strata, nest = T)
      m <- svyciprop(~ever_cc_tested, design = design)
      ci <- confint(m)
  
      return(data.frame("Mean" = as.numeric(m[1]), "Lower" = ci[1], "Upper" = ci[2]))
    } else{
      design <- svydesign(data = sub_df, weights = ~weight, id = ~psu) #may need to add strata
      m <- svyciprop(~ever_cc_tested, design = design)
      ci <- confint(m)
  
      return(data.frame("Mean" = as.numeric(m[1]), "Lower" = ci[1], "Upper" = ci[2]))
    }
  }
}

#function for pap smear
everhadpapsmear <- function(df, age1, age2){
  sub_df <- filter(df, age >= age1 & age <= age2 & !is.na(ever_had_pap_smear))
  
  if(nrow(sub_df) <= 1){ #done for age groups that have 1 or less people
    return(data.frame("Mean" = NA, "Lower" = NA, "Upper" = NA))
    
  }else{
     if(length(sub_df$strata) != 0){
      design <- svydesign(data = sub_df, weights = ~weight, id = ~psu, strata = ~strata, nest = T)
      m <- svyciprop(~ever_had_pap_smear, design = design)
      ci <- confint(m)
  
      return(data.frame("Mean" = as.numeric(m[1]), "Lower" = ci[1], "Upper" = ci[2]))
    } else{
      design <- svydesign(data = sub_df, weights = ~weight, id = ~psu) #may need to add strata
      m <- svyciprop(~ever_had_pap_smear, design = design)
      ci <- confint(m)
  
      return(data.frame("Mean" = as.numeric(m[1]), "Lower" = ci[1], "Upper" = ci[2]))
    }
  }
}
```
```{r dhs}
#Benin
evercctested_bndhs <- df_age_fig(agegr, bndhs, evercctested, df)
evercctested_bndhs$df <- "bndhs"

#Cote d'Ivoire
evercctested_cidhs <- df_age_fig(agegr, cidhs, evercctested, df)
evercctested_cidhs$df <- "cidhs"

#Cameroon
evercctested_cmdhs <- df_age_fig(agegr, cmdhs, evercctested, df)
evercctested_cmdhs$df <- "cmdhs"

#Kenya
evercctested_kedhs <- df_age_fig(agegr, kedhs, evercctested, df)
evercctested_kedhs$df <- "kedhs"

everhadpapsmear_kedhs <- df_age_fig(agegr, kedhs, everhadpapsmear, df)
everhadpapsmear_kedhs$df <- "kedhs"

#Lesotho
everhadpapsmear_ls9dhs <- df_age_fig(agegr, ls9dhs, everhadpapsmear, df)
everhadpapsmear_ls9dhs$df <- "ls9dhs"

everhadpapsmear_ls14dhs <- df_age_fig(agegr, ls14dhs, everhadpapsmear, df)
everhadpapsmear_ls14dhs$df <- "ls14dhs"

#Namibia
nm0dhs <- filter(nm0dhs, !is.na(weight) & weight != 0)

everhadpapsmear_nm0dhs <- df_age_fig(agegr, nm0dhs, everhadpapsmear, df)
everhadpapsmear_nm0dhs$df <- "nm0dhs"

nm13dhs <- filter(nm13dhs, !is.na(weight) & weight != 0)

evercctested_nm13dhs <- df_age_fig(agegr, nm13dhs, evercctested, df)
evercctested_nm13dhs$df <- "nm13dhs"

everhadpapsmear_nm13dhs <- df_age_fig(agegr, nm13dhs, everhadpapsmear, df)
everhadpapsmear_nm13dhs$df <- "nm13dhs"

#South Africa
everhadpapsmear_sadhs <- df_age_fig(agegr, sadhs, everhadpapsmear, df)
everhadpapsmear_sadhs$df <- "sadhs"

#Zimbabwe
evercctested_zwdhs <- df_age_fig(agegr, zwdhs, evercctested, df)
evercctested_zwdhs$df <- "zwdhs"
```
```{r kais}
evercctested_kais <- df_age_fig(agegr, kais, evercctested, df)
evercctested_kais$df <- "kais"
```
```{r phia}
evercctested_phia_list <- list(NA)
evercctested_phia <- data.frame(df = NA, agegr = NA)
phia_names <- c("ethphia", "mlphia", "rwphia", "tzphia", "zmphia", "zwphia")

n = 1
for(i in 1:length(phia_list)){
  df <- df_age_fig(agegr, phia_list[[i]], evercctested, df)
  evercctested_phia_list[[i]] <- df
  evercctested_phia[c(n:(n+nrow(df)-1)), 2:5] <- df
  evercctested_phia[c(n:(n+nrow(df)-1)), 1] <- phia_names[i]
  
  df_name <- paste0("evercctested_", phia_names[i])
  names(evercctested_phia_list)[i] <- df_name 
  
  n = n+nrow(df)
}
```
```{r sabssm}
#South Africa
everhadpapsmear_sabssm <- df_age_fig(agegr, sabssm, everhadpapsmear, df)
everhadpapsmear_sabssm$df <- "sabssm"
```
```{r sage}
#Ghana
everhadpapsmear_ghsage <- df_age_fig(agegr, ghsage, everhadpapsmear, df)
everhadpapsmear_ghsage$df <- "ghsage"

#South Africa
everhadpapsmear_sasage <- df_age_fig(agegr, sasage, everhadpapsmear, df)
everhadpapsmear_sasage$df <- "sasage"
```
```{r steps}
#benin
evercctested_bnsteps <- df_age_fig(agegr, bnsteps, evercctested, df)
evercctested_bnsteps$df <- "bnsteps"

#botswana
evercctested_btsteps <- df_age_fig(agegr, btsteps, evercctested, df)
evercctested_btsteps$df <- "btsteps"

#cape verde
evercctested_cpvsteps <- df_age_fig(agegr, cpvsteps, evercctested, df)
evercctested_cpvsteps$df <- "cpvsteps"

#ethiopia
evercctested_ethsteps <- df_age_fig(agegr, ethsteps, evercctested, df)
evercctested_ethsteps$df <- "ethsteps"

#kenya
evercctested_knsteps <- df_age_fig(agegr, knsteps, evercctested, df)
evercctested_knsteps$df <- "knsteps"

#malawi
evercctested_mlsteps <- df_age_fig(agegr, mlsteps, evercctested, df)
evercctested_mlsteps$df <- "mlsteps"

#senegal
snsteps1 <- snsteps
snsteps1$age <- factor(snsteps1$agegr, levels = c("18-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69"), labels = c(21, 27, 32, 37, 42, 47, 52, 57, 62, 67)) #doing this to allow the values to work with the function
snsteps1$age <- as.numeric(as.character(snsteps1$age))
evercctested_snsteps <- df_age_fig(agegr, snsteps1, evercctested, df)
evercctested_snsteps$df <- "snsteps"

#sao tome and principe
evercctested_stpsteps <- df_age_fig(agegr, stpsteps, evercctested, df)
evercctested_stpsteps$df <- "stpsteps"

#swaziland
evercctested_szsteps <- df_age_fig(agegr, szsteps, evercctested, df)
evercctested_szsteps$df <- "szsteps"

#Uganda
evercctested_ugsteps <- df_age_fig(agegr, ugsteps, evercctested, df)
evercctested_ugsteps$df <- "ugsteps"

#Zambia
evercctested_zmsteps <- df_age_fig(agegr, zmsteps, evercctested, df)
evercctested_zmsteps$df <- "zmsteps"
```
```{r combine}
evercctested_df <- rbind(evercctested_bndhs,
                         evercctested_cidhs,
                         evercctested_cmdhs,
                         evercctested_kedhs,
                         evercctested_nm13dhs,
                         evercctested_zwdhs,
                         evercctested_kais,
                         evercctested_phia,
                         evercctested_bnsteps,
                         evercctested_btsteps,
                         evercctested_cpvsteps,
                         evercctested_ethsteps,
                         evercctested_knsteps,
                         evercctested_mlsteps,
                         evercctested_stpsteps,
                         evercctested_szsteps,
                         evercctested_ugsteps,
                         evercctested_zmsteps)
evercctested_df$Type <- "General CC Test"

everhadpapsmear_df <- rbind(everhadpapsmear_kedhs,
                            everhadpapsmear_ls9dhs,
                            everhadpapsmear_ls14dhs,
                            everhadpapsmear_nm0dhs,
                            everhadpapsmear_nm13dhs,
                            everhadpapsmear_sadhs,
                            everhadpapsmear_sabssm)
                            # everhadpapsmear_pooled)
everhadpapsmear_df$Type <- "Pap Smear"

evertest_df <- rbind(evercctested_bndhs,
                     evercctested_cidhs,
                     evercctested_cmdhs,
                         evercctested_kedhs,
                         evercctested_nm13dhs,
                         evercctested_zwdhs,
                         evercctested_kais,
                         evercctested_phia,
                         evercctested_bnsteps,
                         evercctested_btsteps,
                         evercctested_ethsteps,
                         evercctested_knsteps,
                         evercctested_mlsteps,
                         evercctested_szsteps,
                         evercctested_ugsteps,
                         evercctested_zmsteps,
                         #evercctested_pooled,
                         everhadpapsmear_nm0dhs,
                         everhadpapsmear_ls9dhs,
                         everhadpapsmear_ls14dhs,
                         everhadpapsmear_sadhs,
                         everhadpapsmear_sabssm) #Lesotho and namibia pap smear data isn't included in this df
evertest_df <- left_join(evertest_df, surveys)
```
```{r add new surveys}
# new_surveys <- rbind(everhadpapsmear_ghsage, everhadpapsmear_sasage)
# new_surveys <- left_join(new_surveys, select(surveys, -"microdata"))
# evertest_df <- rbind(evertest_df, new_surveys)
```

```{r plots by Country}
ggplot(evertest_df[!is.na(evertest_df$Country) & evertest_df$agegr == "All",], aes(x = Year, y = Mean, colour = Region)) +
  geom_smooth(method = lm) +
  geom_point() +
  geom_errorbar(aes(ymin=Lower, ymax=Upper), width=.5) +
  ylim(0,1) +
  ggtitle("Raw survey statistics: Proportion ever screened for CC among all women\n(includes data from both general CC testing and pap smear only)") +
  theme(axis.text.x = element_text(size = 8, angle = 90, hjust=0.95, vjust=0.2), legend.position = "bottom", legend.text = element_text(size=6), legend.key.size = unit(0.5, 'cm')) + 
  facet_wrap(~Country)
```

```{r plots by Region}
ggplot(evertest_df[!is.na(evertest_df$Country),], aes(x = Year, y = Mean, shape = agegr, lty = agegr)) +
  geom_smooth(method = lm, colour = "black") +
  geom_point(aes(colour = Country)) +
  #geom_errorbar(aes(ymin=Lower, ymax=Upper, colour = Country), width=.5) +
  facet_wrap(~Region) + 
  ylim(0,1) +
  ggtitle("Proportion tested for CC ever among all women\n(includes dath from both general CC testing and pap smear only)") +
  scale_linetype_manual(values = c("solid", "dotted")) +
  scale_shape_manual(values = c(16, 1)) +
  theme(axis.text.x = element_text(size = 8, angle = 90, hjust=0.95, vjust=0.2), legend.position = "bottom", legend.text = element_text(size=6), legend.key.size = unit(0.5, 'cm'))
```

# Proportion cc tested ever by HIV status
```{r age settings}
age.groups <- data.frame(c(15, 18, 15, 25, 30, 50, seq(15, 65, 5), 0), c(49, 49, 29, 49, 49, 1000, seq(19, 64, 5), 1000, 1000))
df <- data.frame(agegr = c(rep("15-49", 2),
                           rep("18-49", 2),
                           rep("15-29", 2), 
                           rep("25-49", 2), 
                           rep("30-49", 2), 
                           rep("50-65+", 2),
                           rep("15-19", 2), 
                           rep("20-24", 2), 
                           rep("25-29", 2), 
                           rep("30-34", 2), 
                           rep("35-39", 2), 
                           rep("40-44", 2), 
                           rep("45-49", 2),
                           rep("50-54", 2),
                           rep("55-59", 2),
                           rep("60-64", 2),
                           rep("65-1000", 2),
                           rep("All",2)))
```
```{r prop tested ever by hiv function}
options(survey.lonely.psu="adjust")
#function for general cc testing
hiv_evercctested <- function(df, age1, age2){
  sub_df <- filter(df, age >= age1 & age <= age2 & !is.na(ever_cc_tested) & !is.na(hivstat))
  
  if(nrow(sub_df) <= 1){ #done for age groups + hiv status that have 1 or less people
    return(data.frame("Mean" = NA, "Lower" = NA, "Upper" = NA))
    
  }else{
    design <- svydesign(data = sub_df, weights = ~weight, id = ~psu, strata = ~strata, nest = T) #may need to add strata
    m <- svyby(~ever_cc_tested, ~hivstat, svyciprop, design = design, vartype = "ci", method = "beta")

    results <- data.frame(Status = c("HIV-", "HIV+"),
                          Mean = m[,2], Lower = m[,3], Upper = m[,4])
    for(i in 1:nrow(results)){
      if(is.nan(results$Lower[i])){
        results$Lower[i] <- 0
      }
      if(is.nan(results$Upper[i])){
        results$Upper[i] <- 0
      }
    }
    return(results)
  }
}

#function for pap smear
hiv_everhadpapsmear <- function(df, age1, age2){
  sub_df <- filter(df, age >= age1 & age <= age2 & !is.na(ever_had_pap_smear) & !is.na(hivstat))
  
  if(nrow(sub_df) <= 1){ #done for age groups + hiv status that have 1 or less people
    return(data.frame("Mean" = NA, "Lower" = NA, "Upper" = NA))
    
  }else{
    
    design <- svydesign(data = sub_df, weights = ~weight, id = ~psu, strata = ~strata, nest = T) #may need to add strata
    m <- svyby(~ever_had_pap_smear, ~hivstat, svyciprop, design = design, vartype = "ci", method = "beta")
  
    results <- data.frame(Status = c("HIV-", "HIV+"),
                          Mean = m[,2], Lower = m[,3], Upper = m[,4])
    return(results)
  }
}
```
```{r dhs hiv}
#Cameroon
hiv_evercctested_cmdhs <- df_age_fig(age.groups, cmdhs, hiv_evercctested, df)
hiv_evercctested_cmdhs$df <- "cmdhs"

#Cote d'Ivoire
hiv_evercctested_cidhs <- df_age_fig(age.groups, cidhs, hiv_evercctested, df)
hiv_evercctested_cidhs$df <- "cidhs"

#Lesotho
hiv_everhadpapsmear_ls9dhs <- df_age_fig(age.groups, ls9dhs, hiv_everhadpapsmear, df)
hiv_everhadpapsmear_ls9dhs$df <- "ls9dhs"

hiv_everhadpapsmear_ls14dhs <- df_age_fig(age.groups, ls14dhs, hiv_everhadpapsmear, df)
hiv_everhadpapsmear_ls14dhs$df <- "ls14dhs"

#Namibia
nm13dhs <- filter(nm13dhs, weight != 0)
hiv_evercctested_nm13dhs <- df_age_fig(age.groups, nm13dhs, hiv_evercctested, df)
hiv_evercctested_nm13dhs$df <- "nm13dhs"

hiv_everhadpapsmear_nm13dhs <- df_age_fig(age.groups, nm13dhs, hiv_everhadpapsmear, df)
hiv_everhadpapsmear_nm13dhs$df <- "nm13dhs"

#South Africa
hiv_everhadpapsmear_sadhs <- df_age_fig(age.groups, sadhs, hiv_everhadpapsmear, df)
hiv_everhadpapsmear_sadhs$df <- "sadhs"

#Zimbabwe
hiv_evercctested_zwdhs <- df_age_fig(age.groups, zwdhs, hiv_evercctested, df)
hiv_evercctested_zwdhs$df <- "zwdhs"

hiv_evercctested(nm13dhs, 60, 64)
```
```{r kais hiv}
#South Africa
hiv_evercctested_kais <- df_age_fig(age.groups, kais, hiv_evercctested, df)
hiv_evercctested_kais$df <- "kais"
```
```{r phia hiv}
hiv_evercctested_phia_list <- list(NA)
hiv_evercctested_phia <- data.frame(df = NA, agegr = NA)
phia_names <- c("ethphia", "mlphia", "rwphia", "tzphia", "zmphia", "zwphia")

n = 1
for(i in 1:length(phia_list)){
  df <- df_age_fig(age.groups, phia_list[[i]], hiv_evercctested, df)
  hiv_evercctested_phia_list[[i]] <- df
  hiv_evercctested_phia[c(n:(n+nrow(df)-1)), 2:6] <- df
  hiv_evercctested_phia[c(n:(n+nrow(df)-1)), 1] <- phia_names[i]
  
  df_name <- paste0("hiv_evercctested_", phia_names[i])
  names(hiv_evercctested_phia_list)[i] <- df_name 
  
  n = n+nrow(df)
}
```
```{r sabssm hiv}
#South Africa
hiv_everhadpapsmear_sabssm <- df_age_fig(age.groups, sabssm, hiv_everhadpapsmear, df)
hiv_everhadpapsmear_sabssm$df <- "sabssm"
```
```{r pooled hiv}
hiv_evercctested_pooled <- df_age_fig(age.groups, pooled_surveys1, hiv_evercctested, df)
hiv_everhadpapsmear_pooled <- df_age_fig(age.groups, pooled_surveys1, hiv_everhadpapsmear, df)

hiv_evercctested_pooled$df <- "pooled"
hiv_everhadpapsmear_pooled$df <- "pooled"
```
```{r combine hiv}
hiv_evercctested_df <- rbind(hiv_evercctested_cidhs,
                             hiv_evercctested_zwdhs,
                             hiv_evercctested_nm13dhs,
                             hiv_evercctested_kais,
                      hiv_evercctested_phia,
                      hiv_evercctested_pooled)
hiv_evercctested_df$Type <- "General CC Test"

hiv_everhadpapsmear_df <- rbind(hiv_everhadpapsmear_ls9dhs,
                        hiv_everhadpapsmear_ls14dhs,
                        hiv_everhadpapsmear_nm13dhs,
                        hiv_everhadpapsmear_sadhs,
                        hiv_everhadpapsmear_sabssm,
                        hiv_everhadpapsmear_pooled)
hiv_everhadpapsmear_df$Type <- "Pap Smear"

hiv_evertest_df <- rbind(hiv_evercctested_cmdhs,
                         hiv_evercctested_cidhs,
                         hiv_evercctested_zwdhs,
                         hiv_evercctested_nm13dhs,
                         hiv_evercctested_kais,
                         hiv_evercctested_phia,
                         hiv_evercctested_pooled,
                         hiv_everhadpapsmear_ls9dhs,
                         hiv_everhadpapsmear_ls14dhs,
                         hiv_everhadpapsmear_sadhs,
                         hiv_everhadpapsmear_sabssm,
                         hiv_everhadpapsmear_pooled)

hiv_evertest_df <- left_join(hiv_evertest_df, surveys)
hiv_evertest_df <- hiv_evertest_df[,c("agegr", "Status", "Mean", "Lower", "Upper", "df", "Country", "Survey", "Year", "Region")]
```
```{r add new surveys}
# new_surveys <- rbind(hiv_evercctested_cmdhs)
# new_surveys <- left_join(new_surveys, select(surveys, -"microdata"))
# hiv_evertest_df <- rbind(hiv_evertest_df, new_surveys)
```
```{r plots hiv, fig.height = 9}
a <- filter(hiv_evertest_df, agegr == "15-19" |
                             agegr == "20-24"| 
                             agegr == "25-29"|
                             agegr == "30-34"| 
                             agegr == "35-39"| 
                             agegr == "40-44"| 
                             agegr == "45-49"| 
                             agegr == "50-54"| 
                             agegr == "55-59"| 
                             agegr == "60-64"| 
                             agegr == "65-1000")
a$agegr <- factor(a$agegr, levels = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-1000"))
ggplot(na.omit(a), aes(x=agegr, y = Mean, fill = Status)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_wrap(~df) +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_manual(name = "HIV Status", values = c("dodgerblue3", "lightsalmon1"))
```

```{r, fig.height = 9}
ggplot(hiv_evertest_df[!is.na(hiv_evertest_df$Country) & hiv_evertest_df$Type == "Pap Smear" & hiv_evertest_df$Survey != "zamsteps",], 
       aes(x = Country, y = Prop, fill = Status)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin=Lower, ymax=Upper), width=.5, position = position_dodge(0.9)) +
  ylim(0,1) +
  ggtitle("Proportion had pap smear ever \namong all women 18-49 by HIV status") +
  facet_grid(Survey~Year, scales = "free", space = "free") +
  theme(axis.text.x = element_text(size = 8, angle = 90, hjust=0.95, vjust=0.2), legend.position = "bottom")
```

```{r, fig.height = 9}
ggplot(hiv_evertest_df[hiv_evertest_df$df == "pooled",], aes(x = Type, y = Prop, fill = Status)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin=Lower, ymax=Upper), width=.5, position = position_dodge(0.9)) +
  ylim(0,1) +
  ggtitle("Proportion CC tested ever \namong women 18-49 in SSA by HIV status\n(unweighted)") +
  theme(axis.text.x = element_text(size = 8, angle = 90, hjust=0.95, vjust=0.2), legend.position = "bottom") 
```

# Save
```{r save datasets}
#hiv_evertest_1549_df <- hiv_evertest_df
#load("CC Testing Ever")
save(evertest_df, 
     hiv_evertest_df, 
     hiv_evertest_3049_df,
     hiv_evertest_1549_df,
     file = "CC Testing Ever")
```