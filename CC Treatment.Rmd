---
title: "CC Treatment"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      warning = F)
```

```{r import}
library(haven)
library(dplyr)
library(survey)
library(ggplot2)
library(readxl)
source("df_functions.R") #functions created for dataframes
load("Cleaned Indv Surveys") #from Combine Clean Surveys.Rmd
load("Cleaned Pooled Surveys") #from Combine Clean Surveys.Rmd

surveys <- read_excel("surveys.xlsx", sheet = 1)
all_q <- read_excel("surveys.xlsx", sheet = 2)
```

```{r age settings}
age.groups <- data.frame(c(18, 30, 0), c(49, 49, 1000))
df <- data.frame(Age.Groups = c("18-49", "30-49", "All"))
```

<!-- # Treatment among women with abnormal results at last CC test -->
```{r cc treated function among those with positive test result + suspect cancer}
cctreated <- function(df, age1, age2){
  sub_df <- filter(df, age >= age1 & age <= age2 & !is.na(cc_treated))
  
  if(nrow(sub_df) <= 1){
    return(data.frame("Mean" = NA, "Lower" = NA, "Upper" = NA))
    
  }else{
    design <- svydesign(data = sub_df, weights = ~weight, id = ~psu)
    m <- svyciprop(~cc_treated, design = design)
    ci <- confint(m)
  
    return(data.frame("Mean" = as.numeric(m[1]), "Lower" = ci[1], "Upper" = ci[2]))
  }
}
options(survey.lonely.psu = "adjust")
```
```{r cc treated among those with positive test result + suspect cancer}
cctreated_mlphia <- df_age_fig(age.groups, mlphia, cctreated, df)
cctreated_mlphia$df <- "mlphia"

cctreated_tzphia <- df_age_fig(age.groups, tzphia, cctreated, df)
cctreated_tzphia$df <- "tzphia"

cctreated_zmphia <- df_age_fig(age.groups, zmphia, cctreated, df)
cctreated_zmphia$df <- "zmphia"

cctreated_cpvsteps <- df_age_fig(age.groups, cpvsteps, cctreated, df)
cctreated_cpvsteps$df <- "cpvsteps"
```
```{r cc treated function among those with positive test result without suspect cancer}
cctreated_pc <- function(df, age1, age2){
  sub_df <- filter(df, age >= age1 & age <= age2 & !is.na(cc_treated_pc))
  
  if(nrow(sub_df) <= 1){
    return(data.frame("Mean" = NA, "Lower" = NA, "Upper" = NA))
    
  }else{
    design <- svydesign(data = sub_df, weights = ~weight, id = ~psu) 
    m <- svyciprop(~cc_treated_pc, design = design)
    ci <- confint(m)
  
    return(data.frame("Mean" = as.numeric(m[1]), "Lower" = ci[1], "Upper" = ci[2]))
  }
}
options(survey.lonely.psu = "adjust")
```
```{r cc treated among those with positive test result without suspect cancer}
mlphia$cc_treated_pc <- mlphia$cc_treated
mlphia$cc_treated_pc[mlphia$last_cc_test_result == 3] <- NA
tzphia$cc_treated_pc <- tzphia$cc_treated
tzphia$cc_treated_pc[tzphia$last_cc_test_result == 3] <- NA
zmphia$cc_treated_pc <- zmphia$cc_treated
zmphia$cc_treated_pc[zmphia$last_cc_test_result == 3] <- NA
cpvsteps$cc_treated_pc <- cpvsteps$cc_treated
cpvsteps$cc_treated_pc[cpvsteps$last_cc_test_result == 4] <- NA

cctreated_pc_mlphia <- df_age_fig(age.groups, mlphia, cctreated_pc, df)
cctreated_pc_mlphia$df <- "mlphia"

cctreated_pc_tzphia <- df_age_fig(age.groups, tzphia, cctreated_pc, df)
cctreated_pc_tzphia$df <- "tzphia"

cctreated_pc_zmphia <- df_age_fig(age.groups, zmphia, cctreated_pc, df)
cctreated_pc_zmphia$df <- "zmphia"

cctreated_pc_cpvsteps <- df_age_fig(age.groups, cpvsteps, cctreated_pc, df)
cctreated_pc_cpvsteps$df <- "cpvsteps"

View(na.omit(zmphia[,c("cc_treated_pc", "strata", "psu")]))
```
```{r combine}
cctreated_df <- rbind(cctreated_mlphia,
                         cctreated_tzphia,
                         cctreated_zmphia,
                         cctreated_cpvsteps)
cctreated_df <- left_join(cctreated_df, surveys)

cctreated_pc_df <- rbind(cctreated_pc_mlphia,
                         cctreated_pc_tzphia,
                         cctreated_pc_zmphia,
                         cctreated_pc_cpvsteps)
cctreated_pc_df <- left_join(cctreated_pc_df, surveys)
```

```{r, plot}
ggplot(cctreated_df, aes(x = Country, y = Mean, fill = Age.Groups)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin=Lower, ymax=Upper), width=.5, position = position_dodge(0.9)) +
  ylim(0,1) +
  ggtitle("Proportion treated among those with an abnormal CC test result") +
  facet_grid(.~Year, scales = "free", space = "free") +
  theme(axis.text.x = element_text(size = 8, angle = 90, hjust=0.95, vjust=0.2), legend.position = "bottom")
```

```{r save datasets}
#load("CC Treatment")
save(cctreated_df, cctreated_pc_df,
     file = "CC Treatment")
```
