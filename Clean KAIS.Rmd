---
title: "KAIS"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import}
library(dplyr)
library(survey)
library(tidyr)
library(ggplot2)
library(knitr)
library(haven)
library(reldist)
source("df_functions.R")

kais_adult <- read_dta("~/Documents/GitHub/HPV-HIV-Model/KAIS/alladults.dta")
```

```{r 2012 clean}
kais <- select(kais_adult,
                c(psu = qclust,
                  strata,
                  weight = aiweight,
                  Year = interviewdate,
                  age = q_102,
                  sex, #male = 1; female = 2
                  region = qprov,
                  #cervical cancer questions
                  ever_cc_tested = q_814,
                  last_cc_test_result = q_815,
                  cc_treatment_referred = q_816,
                  #hiv questions
                  hiv_weight = abweight,
                  hivstat = hiv,
                  arv = onart)) #currently on art

kais$Country <- "Kenya"
kais$df <- "kais"
#create Year variable from interview date
kais$Year <- as.numeric(substr(kais$Year, 6, 9))

#recode
##hiv testing questions
kais$hivstat[kais$hivstat == 2] <- 0 #changing values of hiv- from 2 to 0

##cervical cancer questions
#ever screened
kais$ever_cc_tested[kais$ever_cc_tested == 2] <- 0 #changing values of no from 2 to 0
kais$ever_cc_tested[kais$ever_cc_tested == 8] <- NA
#results received
kais$last_cc_test_result[kais$last_cc_test_result == 2] <- 0 #changing values of no from 2 to 0
kais$last_cc_test_result[kais$last_cc_test_result == 8] <- NA
#treatment referral
kais$cc_treatment_referred[kais$cc_treatment_referred == 2] <- 0 #changing values of no from 2 to 0
kais$cc_treatment_referred[kais$cc_treatment_referred == 8] <- NA

save(kais, file = "New Cleaned KAIS")
```
```{r missing}
age.groups = data.frame(l_age = seq(15, 65, 5), u_age = c(seq(19, 64, 5), 1000))
A <- nrow(age.groups)
for(n in 1:nrow(kais_adult)){
  for(a in 1:A){
    if(!is.na(kais_adult$q_102[n]) & age.groups$l_age[a] <= kais_adult$q_102[n] & age.groups$u_age[a] >= kais_adult$q_102[n]){
      agegr <- paste0(age.groups$l_age[a], "-", age.groups$u_age[a])
      kais_adult$agegr[n] <- agegr
    }
  }
}

dat_missing <- data.frame(Survey = NA,
                 agegr = NA,
                 elg_resp = NA,
                 resp = NA,
                 dk = NA,
                 missing = NA)
n=1
for(a in 1:sort(length(unique(kais_adult$agegr)))){
   gr <- sort(unique(kais_adult$agegr))[a]
   df <- filter(kais_adult, sex == 2 | !is.na(q_814))
   df <- filter(df, agegr == gr)
   id <- "kais"
    tbl <- table(df$q_814)
    df_tbl <- data.frame(tbl)
    
    elg_resp <- nrow(df)
    resp <- sum(tbl)
    missing <- elg_resp - resp
    dk <- df_tbl[df_tbl$Var1 == 8 , 2]
    if(length(dk) == 0){
      dk = 0
    }
    
    dat_missing[n, ] <- c(id, gr, elg_resp, resp, dk, missing)
    print(id); print(gr); print(tbl)
    n=n+1
}
```