---
title: "Pooled Surveys"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import}
library(haven)
library(dplyr)
library(survey)
library(ggplot2)
library(readxl)
library(gt)
library(knitr)
library(kableExtra)
source("df_functions.R")

surveys <- read_excel("surveys.xlsx", sheet = 1)
all_q <- read_excel("surveys.xlsx", sheet = 2)
eco_det <- read_excel("surveys.xlsx", sheet = 5)

# load("Cleaned Pooled Surveys")
# load("Cleaned Indv Surveys")
load("New Cleaned DHS")
load("New Cleaned KAIS")
load("New Cleaned PHIA")
load("New Cleaned STEPS")
load("New Cleaned SABSSM")
load("New Cleaned SAGE")
load("New Cleaned WHS")
```
```{r merge datasets}
#DHS
dhs_list <- list(bndhs,
                 cidhs,
                 cmdhs,
                 kedhs,
                 ls9dhs,
                 ls14dhs,
                 nm0dhs,
                 nm13dhs,
                 sadhs,
                 tzdhs,
                 zwdhs)
                 
dhs <- Reduce(
  function(x, y, all = T)
  merge(x, y, all = T),
  dhs_list
)
dhs$Survey <- "DHS"

#PHIA
phia_list <- list(ethphia,
                  mlphia,
                  rwphia,
                  tzphia,
                  zmphia,
                  zwphia)

phia <- Reduce(
  function(x, y, all = T)
  merge(x, y, all = T),
  phia_list
)
phia$Survey <- "PHIA"

#SAGE
sage_list <- list(ghsage,
                   sasage)

sage <- Reduce(
  function(x, y, all = T)
  merge(x, y, all = T),
  sage_list
)
sage$Survey <- "SAGE"

#STEPS
steps_list <- list(bnsteps,
                   btsteps,
                   cpvsteps,
                   ethsteps,
                   knsteps,
                   mlsteps,
                   snsteps,
                   stpsteps,
                   szsteps,
                   ugsteps,
                   zmsteps)

steps <- Reduce(
  function(x, y, all = T)
  merge(x, y, all = T),
  steps_list
)
steps$Survey <- "STEPS"

#WHS
abrv = c("bf", "ch", "ci", "cm", "cn", "eth",
         "gh", "kn", "ma", "ml", "mrt", "mus",
         "nm", "sa", "sn", "sz", "zm", "zw")

countries = c("Burkina Faso", "Chad", "Cote d'Ivoire", "Comoros", "Congo (Rep)", "Ethiopia", "Ghana", "Kenya", "Mali", "Malawi", "Mauritania", "Mauritius", "Namibia", "South Africa", "Senegal", "Eswatini", "Zambia", "Zimbabwe")

whs <- list(bfwhs, chwhs, ciwhs, cmwhs, cnwhs, ethwhs, ghwhs,
               knwhs, mawhs, mlwhs, mrtwhs, muswhs, nmwhs,
               sawhs, snwhs, szwhs, zmwhs, zwwhs)

whs_names <- c("bfwhs", "chwhs", "ciwhs", "cmwhs", "cnwhs", "ethwhs", "ghwhs",
               "knwhs", "mawhs", "mlwhs", "mrtwhs", "muswhs", "nmwhs",
               "sawhs", "snwhs", "szwhs", "zmwhs", "zwwhs")

names(whs) <- countries

#adding country and df variable
for(i in 1:length(whs)){
  whs[[i]]$Country <- countries[i]
  whs[[i]]$df <- paste0(abrv[i], "whs")
  #print(nrow(whs_list[[i]]))
}

#if list already created in "All WHS.R"
whs_list <- whs

whs <- Reduce(
  function(x, y, all = T)
  merge(x, y, all = T),
  whs_list
)
whs$Survey <- "WHS"

sabssm$Survey <- "SABSSM"
sabssm$df <- "sabssm"

kais$Survey <- "KAIS"
kais$df <- "kais"

surveys_list <- list(dhs, phia, sage, steps, whs, sabssm, kais)

pooled_surveys <- Reduce(
  function(x, y, all = T)
  merge(x, y, all = T),
  surveys_list
)

store <- pooled_surveys
#pooled_surveys <- store

pooled_surveys$Year <- as.numeric(pooled_surveys$Year)
surveys <- unique(surveys[,c("Region", "Country", "Survey")]) #unique bc there's 2 DHS surveys from Lesotho
pooled_surveys <- left_join(pooled_surveys, surveys)
a <- left_join(pooled_surveys, surveys)

names(pooled_surveys)[names(pooled_surveys) == "psu"] <- "psu_raw"
pooled_surveys$psu <- paste0(pooled_surveys$df, "-", pooled_surveys$psu_raw)
```
```{r save dataframes}
save(dhs, phia, sage, steps, whs, sabssm, kais,
     pooled_surveys, 
     dhs_list, phia_list, sage_list, steps_list, whs_list, 
     file = "New Cleaned Pooled Surveys")

save(bndhs, cidhs, cmdhs, kedhs, ls9dhs, ls14dhs, nm0dhs, nm13dhs, sadhs, tzdhs, zwdhs,
     ethphia, mlphia, rwphia, tzphia, zmphia, zwphia,
     bfwhs, sabssm, bfwhs, chwhs, ciwhs, cmwhs, cnwhs, ethwhs, ghwhs, 
     knwhs, mawhs, mlwhs, mrtwhs, muswhs, nmwhs, sawhs, snwhs, szwhs, zmwhs, zwwhs, 
     bnsteps, btsteps, cpvsteps, ethsteps, knsteps, mlsteps, snsteps, stpsteps, szsteps, ugsteps, zmsteps,
     sabssm,
     kais,
     ghsage, sasage,
     file = "New Cleaned Indv Surveys")
```


