---
title: "SABSSM"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import}
library(dplyr)
library(survey)
library(tidyr)
library(ggplot2)
library(knitr)
library(haven)
library(reldist)
source("df_functions.R")

sabssm2012 <- read.csv("~/Documents/GitHub/HPV-HIV-Model/SABSSM/SABSSM2012_Adult.csv")
```

```{r 2012 clean}
sabssm <- select(sabssm2012,
                c(psu = ea,
                  weight = ibreal12,
                  age = Q1_1,
                  sex = Q1_2,
                  region = province,
                  urban_rural = geotype,
                  #cervical cancer questions
                  ever_had_pap_smear = Q8_13,
                  last_pap_smear = Q8_14,
                  #hiv questions
                  hivstat,
                  arv))

sabssm$Year <- 2012
sabssm$Country <- "South Africa"
sabssm$df <- "sabssm"
sabssm$strata <- paste0(sabssm$region, "-", sabssm$urban_rural)

#recode
##determinants
#cleaning arv data
sabssm$arv[sabssm$arv == 2] = 0

#change coding of hivstat so hiv negative == 0 
sabssm$hivstat[sabssm$hivstat == 2] <- 0

##cervical cancer questions
#recode pap smear questions
sabssm$ever_had_pap_smear[sabssm$ever_had_pap_smear == 2] = 0

#create cc test past 3 year question among everyone
sabssm$pap_smear_past_3y[sabssm$ever_had_pap_smear == 0] <- 0
sabssm$pap_smear_past_3y[sabssm$ever_had_pap_smear == 1 & sabssm$last_pap_smear > 2] <- 0
sabssm$pap_smear_past_3y[sabssm$ever_had_pap_smear == 1 & sabssm$last_pap_smear <= 2] <- 1

#create cc test past year
sabssm$pap_smear_past_1y[sabssm$ever_had_pap_smear == 0] <- 0
sabssm$pap_smear_past_1y[sabssm$ever_had_pap_smear == 1 & sabssm$last_pap_smear == 1] <- 1
sabssm$pap_smear_past_1y[sabssm$ever_had_pap_smear == 1 & sabssm$last_pap_smear != 1] <- 0

sabssm$pap_smear_past_5y[sabssm$ever_had_pap_smear == 0] <- 0
sabssm$pap_smear_past_5y[sabssm$ever_had_pap_smear == 1 & sabssm$last_pap_smear > 3] <- 0
sabssm$pap_smear_past_5y[sabssm$ever_had_pap_smear == 1 & sabssm$last_pap_smear <= 3] <- 1

sabssm <- filter(sabssm, (sex == 2) & (!is.na(weight)))
hivp_sabssm <- filter(sabssm, (sex == 2) & (!is.na(weight)) & hivstat == 1)
hivn_sabssm <- filter(sabssm, (sex == 2) & (!is.na(weight)) & hivstat == 0)

save(sabssm, file = "New Cleaned SABSSM")
```

```{r missing data}
a <- filter(sabssm2012, Q1_2 == 2 | !is.na(Q8_13))
nrow(a)
nrow(sabssm2012)
sum(table(sabssm2012$Q8_13))
sum(table(a$Q8_13))

age.groups = data.frame(l_age = seq(15, 65, 5), u_age = c(seq(19, 64, 5), 1000))
A <- nrow(age.groups)
for(n in 1:nrow(sabssm2012)){
  for(a in 1:A){
    if(!is.na(sabssm2012$Q1_1[n]) & age.groups$l_age[a] <= sabssm2012$Q1_1[n] & age.groups$u_age[a] >= sabssm2012$Q1_1[n]){
      agegr <- paste0(age.groups$l_age[a], "-", age.groups$u_age[a])
      sabssm2012$agegr[n] <- agegr
    }
  }
}

dat_missing <- data.frame(Survey = NA,
                 agegr = NA,
                 elg_resp = NA,
                 resp = NA,
                 dk = NA,
                 missing = NA)
n=1
for(a in 1:sort(length(unique(sabssm2012$agegr)))){
   gr <- sort(unique(sabssm2012$agegr))[a]
   df <- filter(sabssm2012, Q1_2 == 2 | !is.na(Q8_13))
    df <- filter(df, agegr == gr)
    id <- "sabssm"
    tbl <- table(df$Q8_13)
    df_tbl <- data.frame(tbl)
    
    elg_resp <- nrow(df)
    resp <- sum(tbl)
    missing <- elg_resp - resp
    dat_missing[n, ] <- c(id, gr, elg_resp, resp, dk, missing)
    print(id); print(gr); print(tbl)
    n=n+1
}

sum(as.numeric(dat_missing$missing))
```