---
title: "STEPS - check the urban/rural + strata"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import}
library(dplyr)
library(survey)
library(ggplot2)
library(haven)
library(readxl)
source("df_functions.R")

bnsteps_raw <- read.csv("~/Documents/GitHub/HPV-HIV-Model/Steps/Benin/ben2015.csv")
btsteps_raw <- read.csv("~/Documents/GitHub/HPV-HIV-Model/Steps/Botswana/bwa2014.csv")
cpvsteps_raw <- read_excel("~/Documents/GitHub/HPV-HIV-Model/Steps/Cape Verde/cpv2019.xlsx", sheet = 1)
ethsteps_raw <- read.csv("~/Documents/GitHub/HPV-HIV-Model/Steps/Ethiopia/eth2015.csv")
knsteps_raw <- read_sav("~/Documents/GitHub/HPV-HIV-Model/Steps/Kenya/ken2015.sav")
mlsteps_raw <- read.csv("~/Documents/GitHub/HPV-HIV-Model/Steps/Malawi/mwi2017.csv")
snsteps_raw <- read_sav("~/Documents/GitHub/HPV-HIV-Model/Steps/Senegal/sen2014.sav")
stpsteps_raw <- read_excel("~/Documents/GitHub/HPV-HIV-Model/Steps/Sao Tome and Principe/stp2019.xlsx", sheet = 1)
szsteps_raw <- read.csv("~/Documents/GitHub/HPV-HIV-Model/Steps/Swaziland/swz2014.csv")
ugsteps_raw <- read.csv("~/Documents/GitHub/HPV-HIV-Model/Steps/Uganda/uga2014.csv")
zmsteps_raw <- read.csv("~/Documents/GitHub/HPV-HIV-Model/Steps/Zambia/zmb2017.csv")
```

```{r benin clean}
bnsteps <- select(bnsteps_raw,
                   c(psu,
                     strata = stratum, #urban = 1; rural = 2
                     weight = wstep1,
                     age,
                     sex, #Men; Women
                     ever_cc_tested = cx1))
bnsteps$ever_cc_tested[bnsteps$ever_cc_tested == 77] <- NA #code don't know as NA
bnsteps$ever_cc_tested[bnsteps$ever_cc_tested == 2] <- 0
bnsteps$Year <- 2015
bnsteps$Country <- "Benin"
bnsteps$df <- "bnsteps"

#Recode sex
bnsteps$sex[bnsteps$sex == "Men"] <- 1
bnsteps$sex[bnsteps$sex == "Women"] <- 2

bnsteps <- filter(bnsteps, sex == 2 & !is.na(weight))
```
```{r botswana clean}
btsteps <- select(btsteps_raw,
                   c(psu,
                     strata = stratum,
                     weight = wstep1,
                     age,
                     sex,
                     ever_cc_tested = cx1))
btsteps$ever_cc_tested[btsteps$ever_cc_tested == 77] <- NA #code don't know as NA
btsteps$ever_cc_tested[btsteps$ever_cc_tested == 2] <- 0
btsteps$Year <- 2014
btsteps$Country <- "Botswana"
btsteps$df <- "btsteps"

#Recode sex
btsteps$sex[btsteps$sex == "Men"] <- 1
btsteps$sex[btsteps$sex == "Women"] <- 2

btsteps <- filter(btsteps, sex == 2 & !is.na(weight))
```
```{r cape verde clean}
cpvsteps <- select(cpvsteps_raw,
                   c(psu,
                     strata = stratum,
                     weight = wstep1,
                     age,
                     sex,
                     ever_cc_tested = cx1,
                     age_first_tested = cx2,
                     last_cc_test = cx3,
                     last_cc_test_result = cx6,
                     cc_treated = cx8))

cpvsteps$Year <- 2019
cpvsteps$Country <- "Cape Verde"
cpvsteps$df <- "cpvsteps"

#Recode sex
cpvsteps$sex[cpvsteps$sex == "Men"] <- 1
cpvsteps$sex[cpvsteps$sex == "Women"] <- 2

#cervical cancer questions
cpvsteps$ever_cc_tested[cpvsteps$ever_cc_tested == 77] <- NA #code don't know as NA
cpvsteps$ever_cc_tested[cpvsteps$ever_cc_tested == 2] <- 0

cpvsteps$age_first_tested[cpvsteps$age_first_tested == 77] <- NA #code don't know as NA
cpvsteps$age_first_tested[cpvsteps$age_first_tested > cpvsteps$age] <- NA

cpvsteps$last_cc_test[cpvsteps$last_cc_test == 77] <- NA #code don't know as NA
cpvsteps$cc_test_past_1y[cpvsteps$last_cc_test == 1 & cpvsteps$ever_cc_tested == 1] <- 1
cpvsteps$cc_test_past_1y[cpvsteps$last_cc_test > 1] <- 0
cpvsteps$cc_test_past_1y[cpvsteps$ever_cc_tested == 0] <- 0

cpvsteps$cc_treated[cpvsteps$cc_treated == 77] <- NA
cpvsteps$cc_treated[cpvsteps$last_cc_test_result == 5 | cpvsteps$last_cc_test_result == 77] <- NA
cpvsteps$cc_treated[cpvsteps$cc_treated == 2] <- 0

cpvsteps <- filter(cpvsteps, sex == 2 & !is.na(weight))

# sum(table(cpvsteps_raw[cpvsteps_raw$sex == "Women",]$cx1)) - 88
# sum(table(cpvsteps$ever_cc_tested))
# table(is.na(cpvsteps$ever_cc_tested))
```
```{r eswatini clean}
szsteps <- select(szsteps_raw,
                   c(psu,
                     strata = stratum,
                     #can't find urban/rural
                     weight = wstep1,
                     age,
                     sex,
                     ever_cc_tested = cx1))
szsteps$ever_cc_tested[szsteps$ever_cc_tested == 77] <- NA #code don't know as NA
szsteps$ever_cc_tested[szsteps$ever_cc_tested == 2] <- 0
szsteps$Year <- 2014
szsteps$Country <- "Eswatini"
szsteps$df <- "szsteps"

#Recode sex
szsteps$sex[szsteps$sex == "Men"] <- 1
szsteps$sex[szsteps$sex == "Women"] <- 2

szsteps <- filter(szsteps, sex == 2 & !is.na(weight))
```
```{r ethiopia clean}
ethsteps <- select(ethsteps_raw,
                   c(psu,
                     strata = stratum,
                     weight = wstep1,
                     age = c3,
                     sex = c1,
                     region,
                     ever_cc_tested = cx1))
ethsteps$ever_cc_tested[ethsteps$ever_cc_tested == 77] <- NA #code don't know as NA
ethsteps$ever_cc_tested[ethsteps$ever_cc_tested == 2] <- 0
ethsteps$Year <- 2015
ethsteps$Country <- "Ethiopia"
ethsteps$df <- "ethsteps"

ethsteps <- filter(ethsteps, sex == 2 & !is.na(weight))
```
```{r kenya clean}
knsteps <- select(knsteps_raw,
                   c(psu,
                     strata = stratum,
                     weight = wstep1, #there are also wstep2 and 3 - which one should I use (step 1 I believe as it refers to the weights for the interview)
                     age = age,
                     sex = sex,
                     ever_cc_tested = CX1))

knsteps$ever_cc_tested[knsteps$ever_cc_tested == 7] <- NA #code don't know as NA
knsteps$ever_cc_tested[knsteps$ever_cc_tested == 2] <- 0
knsteps$Year <- 2015
knsteps$Country <- "Kenya"
knsteps$df <- "knsteps"

#Recode sex
knsteps$sex[knsteps$sex == "Men"] <- 1
knsteps$sex[knsteps$sex == "Women"] <- 2

knsteps <- filter(knsteps, sex == 2 & !is.na(weight))
```
```{r malawi clean}
mlsteps <- select(mlsteps_raw,
                   c(psu,
                     strata = stratum,
                     weight = wstep1,
                     age,
                     sex,
                    ever_cc_tested = cx1))
mlsteps$ever_cc_tested[mlsteps$ever_cc_tested == 77] <- NA #code don't know as NA
mlsteps$ever_cc_tested[mlsteps$ever_cc_tested == 2] <- 0
mlsteps$Year <- 2017
mlsteps$Country <- "Malawi"
mlsteps$df <- "mlsteps"

#Recode sex
mlsteps$sex[mlsteps$sex == "Men"] <- 1
mlsteps$sex[mlsteps$sex == "Women"] <- 2

mlsteps <- filter(mlsteps, sex == 2 & !is.na(weight))
```
```{r senegal clean}
snsteps <- select(snsteps_raw,
                   c(psu,
                     strata = Stratum,
                     weight = wstep1,
                     interview_month = i4b,
                     Year = i4c,
                     agegr = c3r,
                     sex = c1, #1 = homme;2 = femme
                     ever_cc_tested = cx1))

snsteps$Country <- "Senegal"
snsteps$df <- "snsteps"

#Recode age - this was inferred from the stats on the broad age group 
snsteps$agegr <- as.character(snsteps$agegr)
snsteps$agegr[snsteps$agegr == 1] <- "18-24"
snsteps$agegr[snsteps$agegr == 2] <- "25-29"
snsteps$agegr[snsteps$agegr == 3] <- "30-34"
snsteps$agegr[snsteps$agegr == 4] <- "35-39"
snsteps$agegr[snsteps$agegr == 5] <- "40-44"
snsteps$agegr[snsteps$agegr == 6] <- "45-49"
snsteps$agegr[snsteps$agegr == 7] <- "50-54"
snsteps$agegr[snsteps$agegr == 8] <- "55-59"
snsteps$agegr[snsteps$agegr == 9] <- "60-64"
snsteps$agegr[snsteps$agegr == 10] <- "65-69"

snsteps$Year <- as.numeric(snsteps$Year)

#cc screening questions
snsteps$ever_cc_tested[snsteps$ever_cc_tested == 77] <- NA #code don't know as NA
snsteps$ever_cc_tested[snsteps$ever_cc_tested == 2] <- 0

snsteps <- filter(snsteps, sex == 2 & !is.na(weight))
```
```{r sao tome and principe clean}
stpsteps <- select(stpsteps_raw,
                   c(psu,
                     strata = stratum,
                     weight = wstep1,
                     age,
                     sex,
                     ever_cc_tested = cx1))

stpsteps$Year <- 2019
stpsteps$Country <- "Sao Tome and Principe"
stpsteps$df <- "stpsteps"

#Recode sex
stpsteps$sex[stpsteps$sex == "Men"] <- 1
stpsteps$sex[stpsteps$sex == "Women"] <- 2

#cc screening questions
stpsteps$ever_cc_tested[stpsteps$ever_cc_tested == 77] <- NA #code don't know as NA
stpsteps$ever_cc_tested[stpsteps$ever_cc_tested == 2] <- 0

stpsteps <- filter(stpsteps, sex == 2 & !is.na(weight))

sum(table(stpsteps_raw[stpsteps_raw$sex == "Women",]$cx1))
sum(table(stpsteps$ever_cc_tested))
table(is.na(stpsteps$ever_cc_tested))
```
```{r uganda clean}
ugsteps <- select(ugsteps_raw,
                   c(psu,
                     strata = stratum, #urban = 1; rural = 2
                     weight = wstep1,
                     age,
                     sex,
                     ever_cc_tested = cx1))
ugsteps$ever_cc_tested[ugsteps$ever_cc_tested == 77] <- NA #code don't know as NA
ugsteps$ever_cc_tested[ugsteps$ever_cc_tested == 2] <- 0
ugsteps$Year <- 2014
ugsteps$Country <- "Uganda"
ugsteps$df <- "ugsteps"

#Recode sex
ugsteps$sex[ugsteps$sex == "Men"] <- 1
ugsteps$sex[ugsteps$sex == "Women"] <- 2

ugsteps <- filter(ugsteps, sex == 2 & !is.na(weight))
```
```{r zambia clean}
zmsteps <- select(zmsteps_raw,
                   c(psu,
                     strata = stratum, #rural = 1; urban = 2
                     weight = wstep1,
                     age,
                     sex,
                     ever_cc_tested = cx1))
zmsteps$ever_cc_tested[zmsteps$ever_cc_tested == 77] <- NA #code don't know as NA
zmsteps$ever_cc_tested[zmsteps$ever_cc_tested == 2] <- 0
zmsteps$Year <- 2017
zmsteps$Country <- "Zambia"
zmsteps$df <- "zmsteps"

#Recode sex
zmsteps$sex[zmsteps$sex == "Men"] <- 1
zmsteps$sex[zmsteps$sex == "Women"] <- 2

#recode urban_rural so that urban = 1 and rural = 2
zmsteps$strata[zmsteps$strata == 1] <- 0
zmsteps$strata[zmsteps$strata == 2] <- 1
zmsteps$strata[zmsteps$strata == 0] <- 2

zmsteps <- filter(zmsteps, sex == 2 & !is.na(weight))
```

```{r missing data}
a <- filter(zmsteps_raw, sex == "Women")
table(a$cx1)
nrow(a)
sum(table(a$cx1))

#View(zmsteps_raw[!is.na(zmsteps_raw$cx1),c("sex", "cx1")])
names(knsteps_raw)[names(knsteps_raw) == "CX1"] <- "cx1"
names(ethsteps_raw)[names(ethsteps_raw) == "c1"] <- "sex"
names(ethsteps_raw)[names(ethsteps_raw) == "c3"] <- "age"
steps_list <- list(bnsteps_raw, btsteps_raw, ethsteps_raw, knsteps_raw, mlsteps_raw, szsteps_raw, ugsteps_raw, zmsteps_raw)
names(steps_list) <- c("bnsteps", "btsteps", "ethsteps", "knsteps", "mlsteps", "szsteps", "ugsteps", "zmsteps")

steps_list <- list(snsteps_raw)
names(steps_list) <- c("snsteps")
age.groups = data.frame(l_age = seq(15, 65, 5), u_age = c(seq(19, 64, 5), 1000))
A <- nrow(age.groups)
for(i in 1:length(steps_list)){
  for(n in 1:nrow(steps_list[[i]])){
    for(a in 1:A){
      if(!is.na(steps_list[[i]]$age[n]) & age.groups$l_age[a] <= steps_list[[i]]$age[n] & age.groups$u_age[a] >= steps_list[[i]]$age[n]){
        agegr <- paste0(age.groups$l_age[a], "-", age.groups$u_age[a])
        steps_list[[i]]$agegr[n] <- agegr
      }
    }
  }
}

steps_list <- list(snsteps_raw)
names(steps_list) <- c("snsteps")
names(steps_list[[1]])[names(steps_list[[1]]) == "c1"] <- "sex"
names(steps_list[[1]])[names(steps_list[[1]]) == "c3r"] <- "agegr"
dat_missing <- data.frame(Survey = NA,
                 agegr = NA,
                 elg_resp = NA,
                 resp = NA,
                 dk = NA,
                 missing = NA)
n=1
for(i in 1:length(steps_list)){
  for(a in 1:length(sort(unique(steps_list[[i]]$agegr)))){
    gr <- sort(unique(steps_list[[i]]$agegr))[a]
    df <- filter(steps_list[[i]], sex == "Women" | sex == 2)
    df <- filter(df, agegr == gr)
    id <- names(steps_list)[i]
    tbl <- table(df$cx1)
    df_tbl <- data.frame(tbl)
    
    elg_resp <- nrow(df)
    resp <- sum(tbl)
    missing <- elg_resp - resp
    dk <- df_tbl[df_tbl$Var1 == 77 , 2]
    if(length(dk) <= 0){
      dk <- 0
    }
    dat_missing[n, ] <- c(id, gr, elg_resp, resp, dk, missing)
    print(id); print(gr); print(tbl)
    n=n+1
  }
}
dat_missing$agegr <- factor(dat_missing$agegr, levels = c("15-19", "20-24", "25-29", "30-34", 
                                                          "35-39", "40-44", "45-49", "50-54", 
                                                          "55-59", "60-64", "65-1000"))
for(i in 1:length(steps_list)){
  a <- filter(dat_missing, Survey == names(steps_list)[i])
  print(sum(as.numeric(a$missing)))
}
```

```{r save}
#load("Cleaned STEPS")
save(bnsteps, btsteps, cpvsteps, ethsteps, knsteps, mlsteps, snsteps, stpsteps, szsteps, ugsteps, zmsteps,
     file = "New Cleaned STEPS")
```
